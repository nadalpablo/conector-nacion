<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ProxyServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WU 100BillersPlus :: Connector nacion-servicios-connector</a> &gt; <a href="index.source.html" class="el_package">com.wu.billersplus.connector.service</a> &gt; <span class="el_source">ProxyServiceImpl.java</span></div><h1>ProxyServiceImpl.java</h1><pre class="source lang-java linenums">package com.wu.billersplus.connector.service;

import java.net.Authenticator;
import java.net.PasswordAuthentication;
import java.net.URL;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.X509Certificate;
import java.util.Map;

import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import javax.xml.ws.BindingProvider;

import org.apache.commons.validator.routines.UrlValidator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.wu.billersplus.connector.entities.ParametrosConector;
import com.wu.billersplus.connector.exceptions.ConectorException;
import com.wu.billersplus.connector.exceptions.ProxyException;
import com.wu.billersplus.framework.configuration.PropertyHelper;
import com.wu.billersplus.framework.entities.BillerResponseWrapper;
import com.wu.billersplus.framework.service.ProxyService;
import com.wu.billersplus.framework.service.impl.ProxyServiceAbstract;

import ar.com.sepsa.commons.model.RespuestaPago;
import us.inswitch.mts.webservices.bn.MTSServiceRED;
import us.inswitch.mts.webservices.bn.MTSServiceREDPortType;
import us.inswitch.mts.webservices.bn.MTSServiceREDServiceException_Exception;
import us.inswitch.mts.webservices.dto.service.request.xsd.DTORequestCashOutConfirm;
import us.inswitch.mts.webservices.dto.service.request.xsd.DTORequestUtfiAutoReversion;
import us.inswitch.mts.webservices.dto.service.response.xsd.DTOResponseCashOutConfirm;
import us.inswitch.mts.webservices.dto.service.response.xsd.DTOResponseUtfiAutoReversion;

public class ProxyServiceImpl extends ProxyServiceAbstract {

<span class="nc" id="L42">	private static Logger logger = LoggerFactory.getLogger(ProxyServiceImpl.class);</span>

	private MTSServiceREDPortType service;

	public ProxyServiceImpl() {
<span class="nc" id="L47">		super();</span>
<span class="nc" id="L48">	}</span>

	@Override
	public BillerResponseWrapper&lt;?&gt; consulta(Object request) throws ConectorException {
<span class="nc" id="L52">		logger.error(&quot;[Conector Codigo {}] La operacion CONSULTA no debería invocarse en este conector&quot;,</span>
				PropertyHelper.getConnectorCode());

<span class="nc" id="L55">		return new BillerResponseWrapper&lt;RespuestaPago&gt;();</span>
	}

	@Override
	public BillerResponseWrapper&lt;?&gt; directa(Object request) throws ConectorException {

<span class="nc" id="L61">		DTORequestCashOutConfirm reqDirecta = (DTORequestCashOutConfirm) request;</span>

<span class="nc" id="L63">		logConectorTraceRequest(reqDirecta, null);</span>

<span class="nc" id="L65">		DTOResponseCashOutConfirm responseDirecta = null;</span>

		try {
<span class="nc" id="L68">			responseDirecta = service.cashOutConfirmRed(reqDirecta);</span>
<span class="nc" id="L69">		} catch (MTSServiceREDServiceException_Exception e) {</span>
<span class="nc" id="L70">			e.printStackTrace();</span>
<span class="nc" id="L71">		}</span>

<span class="nc" id="L73">		logConectorTraceResponse(responseDirecta, null);</span>

<span class="nc" id="L75">		return new BillerResponseWrapper&lt;DTOResponseCashOutConfirm&gt;(responseDirecta, mapBillerTrace(request),</span>
				mapBillerTrace(responseDirecta));
	}

	@Override
	public BillerResponseWrapper&lt;?&gt; reversa(Object request) throws ConectorException {
<span class="nc" id="L81">		DTORequestUtfiAutoReversion reqAnulacion = (DTORequestUtfiAutoReversion) request;</span>

<span class="nc" id="L83">		logConectorTraceRequest(request, null);</span>

<span class="nc" id="L85">		DTOResponseUtfiAutoReversion responseReversa = null;</span>

		try {
<span class="nc" id="L88">			responseReversa = service.utfiAutoReversionRed(reqAnulacion);</span>
<span class="nc" id="L89">		} catch (MTSServiceREDServiceException_Exception e) {</span>
<span class="nc" id="L90">			e.printStackTrace();</span>
<span class="nc" id="L91">		}</span>

<span class="nc" id="L93">		logConectorTraceResponse(request, null);</span>

<span class="nc" id="L95">		return new BillerResponseWrapper&lt;DTOResponseUtfiAutoReversion&gt;(responseReversa, mapBillerTrace(request),</span>
				mapBillerTrace(responseReversa));
	}

	@Override
	public BillerResponseWrapper&lt;?&gt; consultaEstado(Object request) throws ConectorException {
<span class="nc" id="L101">		logger.error(&quot;[Conector Codigo {}] La operacion CONSULTA DE ESTADO no debería invocarse en este conector&quot;,</span>
				PropertyHelper.getConnectorCode());

<span class="nc" id="L104">		return new BillerResponseWrapper&lt;RespuestaPago&gt;();</span>
	}

	@Override
	public ProxyService createClient(Map&lt;String, String&gt; arguments) throws ProxyException {
		/**
		 * Esta operación es la que instancia el proxy que se usará en la
		 * invocación de los servicios. Dentro del mapa de parámetros que viene
		 * como argumentos están todos los parámetros que el usuario de la
		 * aplicación de billers configuró para este conector. Estos parámetros
		 * son los que definimos nosotros al momento de registrar el conector
		 * con la operación com.wu.billersplus.framework.service.impl.
		 * ActualizarConectorServiceImpl.registrarConector(). Este listado de
		 * parametros es el que definimos en el archivo de propiedades en el
		 * atributo connector.parameters
		 * 
		 * En este caso se tenía una interfaz de servicio, por lo que usamos
		 * Resteasy junto con la clase TimeoutExecutor que provee setear un
		 * timeout y sockettimeout al cliente REST. En caso de usar una conexión
		 * HTTP plana se deberá instanciarla a mano
		 * 
		 * POR FAVOR, COMPLETAR LOS LOGS DE INSTANCIACION CON LOS PARAMETROS CON
		 * LOS QUE SE INSTANCIARÁ EL PROXY ASI EN EL SERVIDOR SE PUEDE HACER UN
		 * TRACE DE LOS PROXIES INSTANCIADOS
		 */

		try {
<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (this.service == null) {</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (arguments.get(ParametrosConector.PROXY_URL_PARAMETER) == null) {</span>
<span class="nc" id="L134">					throw new ProxyException(null, ProxyException.URL_INEXISTENTE);</span>
				}

<span class="nc" id="L137">				logger.info(</span>
						&quot;[Conector Codigo {}] Instanciando proxy para el con URL {} connection timeout {} y socket timeout {}&quot;,
						PropertyHelper.getConnectorCode(), arguments.get(ParametrosConector.PROXY_URL_PARAMETER),
						arguments.get(ParametrosConector.PROXY_TIMEOUT_PROPERTY),
						arguments.get(ParametrosConector.PROXY_SOCKETTIMEOUT_PROPERTY));

<span class="nc" id="L143">				boolean trustAllCerts = Boolean</span>
						.parseBoolean(arguments.get(ParametrosConector.TRUSTED_CERTIFICATES_PROPERTY));

<span class="nc bnc" id="L146" title="All 2 branches missed.">				if (!trustAllCerts) {</span>
<span class="nc" id="L147">					boolean valid = UrlValidator.getInstance()</span>
							.isValid(arguments.get(ParametrosConector.PROXY_URL_PARAMETER));
<span class="nc bnc" id="L149" title="All 2 branches missed.">					if (!valid) {</span>
<span class="nc" id="L150">						throw new ProxyException(null, ProxyException.URL_INVALIDA);</span>
					}
				}

				// Configuro el proxy
<span class="nc" id="L155">				this.prepareWebServiceConnection(trustAllCerts, arguments.get(ParametrosConector.USER_PROPERTY),</span>
						arguments.get(ParametrosConector.PASSWORD_PROPERTY));

<span class="nc" id="L158">				URL url = new URL(arguments.get(ParametrosConector.PROXY_URL_PARAMETER) + &quot;?wsdl&quot;);</span>

<span class="nc" id="L160">				service = new MTSServiceRED(url).getMTSServiceREDHttpsSoap11Endpoint();</span>

<span class="nc" id="L162">				((BindingProvider) service).getRequestContext().put(BindingProvider.USERNAME_PROPERTY,</span>
						arguments.get(ParametrosConector.USER_PROPERTY));
<span class="nc" id="L164">				((BindingProvider) service).getRequestContext().put(BindingProvider.PASSWORD_PROPERTY,</span>
						arguments.get(ParametrosConector.PASSWORD_PROPERTY));

			}

<span class="nc" id="L169">		} catch (Exception e) {</span>
<span class="nc" id="L170">			logger.error(&quot;[Conector Codigo {}] Excepcion al crear el proxy&quot;);</span>
<span class="nc" id="L171">			throw new RuntimeException(e);</span>
<span class="nc" id="L172">		}</span>

<span class="nc" id="L174">		return this;</span>
	}

	private void prepareWebServiceConnection(Boolean trustAllCertificates, String username, String password)
			throws NoSuchAlgorithmException, KeyManagementException {

<span class="nc bnc" id="L180" title="All 2 branches missed.">		if (trustAllCertificates) {</span>
			// Marco todos los certificados como validos
<span class="nc" id="L182">			this.disableSSL();</span>

			// Deshabilito la validacion de CN para los certificados
<span class="nc" id="L185">			this.disableCNValidation();</span>
		}

		// Configuro el usuario y la contraseña a utilizar en cada request
<span class="nc" id="L189">		this.configureWebServiceUser(username, password);</span>
<span class="nc" id="L190">	}</span>

	private void disableSSL() throws NoSuchAlgorithmException, KeyManagementException {
<span class="nc" id="L193">		TrustManager[] trustAllCerts = new TrustManager[] { new X509TrustManager() {</span>
			public java.security.cert.X509Certificate[] getAcceptedIssuers() {
<span class="nc" id="L195">				return null;</span>
			}

			public void checkClientTrusted(X509Certificate[] certs, String authType) {
<span class="nc" id="L199">			}</span>

			public void checkServerTrusted(X509Certificate[] certs, String authType) {
<span class="nc" id="L202">			}</span>
		} };

<span class="nc" id="L205">		SSLContext sc = SSLContext.getInstance(&quot;SSL&quot;);</span>
<span class="nc" id="L206">		sc.init(null, trustAllCerts, new java.security.SecureRandom());</span>
<span class="nc" id="L207">		HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());</span>

<span class="nc" id="L209">		HostnameVerifier allHostsValid = new HostnameVerifier() {</span>
			public boolean verify(String hostname, SSLSession session) {
<span class="nc" id="L211">				return true;</span>
			}
		};

<span class="nc" id="L215">		HttpsURLConnection.setDefaultHostnameVerifier(allHostsValid);</span>
<span class="nc" id="L216">	}</span>

	private void disableCNValidation() {
		// Realizado con una property en el standalone-full.xml
<span class="nc" id="L220">	}</span>

	private void configureWebServiceUser(String username, String password) {
<span class="nc" id="L223">		final String authUser = username;</span>
<span class="nc" id="L224">		final String authPassword = password;</span>

<span class="nc" id="L226">		Authenticator.setDefault(new Authenticator() {</span>
			@Override
			public PasswordAuthentication getPasswordAuthentication() {
<span class="nc" id="L229">				return new PasswordAuthentication(authUser, authPassword.toCharArray());</span>
			}
		});
<span class="nc" id="L232">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>