<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EchoServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WU 100BillersPlus :: Connector nacion-servicios-connector</a> &gt; <a href="index.source.html" class="el_package">com.wu.billersplus.connector.service</a> &gt; <span class="el_source">EchoServiceImpl.java</span></div><h1>EchoServiceImpl.java</h1><pre class="source lang-java linenums">package com.wu.billersplus.connector.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;

import javax.ejb.Stateless;

import org.apache.commons.io.IOUtils;
import org.joda.time.DateTime;
import org.joda.time.Interval;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.wu.billersplus.connector.entities.ConnectorRequest;
import com.wu.billersplus.connector.entities.ConnectorResponse;
import com.wu.billersplus.connector.exceptions.ConectorException;
import com.wu.billersplus.entities.PagoResponse;
import com.wu.billersplus.framework.cdi.qualifiers.BillerPlusServiceBean;
import com.wu.billersplus.framework.configuration.PropertyHandler;
import com.wu.billersplus.framework.configuration.PropertyHelper;
import com.wu.billersplus.framework.entities.BillerResponseWrapper;
import com.wu.billersplus.framework.service.ActualizarConectorService;
import com.wu.billersplus.framework.service.ProxyHelperService;
import com.wu.billersplus.framework.service.ProxyService;
import com.wu.billersplus.framework.service.facade.AnalizarErrorService;
import com.wu.billersplus.framework.service.impl.EchoServiceAbstract;
import com.wu.billersplus.framework.transformer.BillerPlusTransformerService;

import us.inswitch.mts.webservices.dto.service.request.xsd.DTORequestCashOutConfirm;

/**
 * 
 * Servicio que implementa la operación de ECHO del servicio. En caso de una
 * respuesta satisfactoria del cliente, se debe retornar la cantidad de
 * milisegundos que tardó el servicio en contestar. En caso de una error con
 * severidad no crítica se debe devolver el valor de ERROR_NO_CRITICO, caso de
 * error crítico se debería deolver el vlaor de ERROR_CRITICO. En caso de un
 * error de configuracion devolver ERROR_CONFIGURACION
 * 
 * A modo de sugerencia, ya se tiene importado en el proyecto JodaTime, por lo
 * que hacer la diferencia de tiempo es mínimo con esta librería
 *
 */
@Stateless
@BillerPlusServiceBean
public class EchoServiceImpl extends EchoServiceAbstract {

<span class="nc" id="L50">	private static final Logger logger = LoggerFactory.getLogger(EchoServiceImpl.class);</span>
	private static final String ECHO_FILE_REQUEST = &quot;requestEcho.json.file.path&quot;;

	public EchoServiceImpl(ProxyHelperService pHelper, BillerPlusTransformerService transformer,
			AnalizarErrorService aErrorService, ActualizarConectorService actualizarService) {
<span class="nc" id="L55">		super(pHelper, transformer, aErrorService, actualizarService);</span>
<span class="nc" id="L56">	}</span>

	public EchoServiceImpl() {
<span class="nc" id="L59">		super();</span>
<span class="nc" id="L60">	}</span>

	@Override
	public Long echoBiller(ProxyService client, String productoUtilityCode, String obj) throws ConectorException {

<span class="nc bnc" id="L65" title="All 2 branches missed.">		if (PropertyHandler.getPropertyString(ECHO_FILE_REQUEST) == null) {</span>
<span class="nc" id="L66">			logger.error(&quot;No se seteo valor para la property {} en el conector&quot;, ECHO_FILE_REQUEST);</span>
<span class="nc" id="L67">			return ERROR_CONFIGURACION;</span>
		}

<span class="nc" id="L70">		logger.debug(&quot;Se buscará el request de echo con el archivo {}&quot;,</span>
				PropertyHandler.getPropertyString(ECHO_FILE_REQUEST));

<span class="nc" id="L73">		InputStream inputStream = getClass().getClassLoader()</span>
				.getResourceAsStream(PropertyHandler.getPropertyString(ECHO_FILE_REQUEST));
<span class="nc" id="L75">		BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));</span>

<span class="nc" id="L77">		String requestJson = null;</span>
		try {
<span class="nc" id="L79">			requestJson = IOUtils.toString(reader);</span>
<span class="nc" id="L80">		} catch (IOException e1) {</span>
<span class="nc" id="L81">			logger.error(&quot;No existe el archivo {} que contiene al request de ECHO&quot;,</span>
					PropertyHandler.getPropertyString(ECHO_FILE_REQUEST));
<span class="nc" id="L83">			return ERROR_CONFIGURACION;</span>
<span class="nc" id="L84">		}</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">		if (requestJson.isEmpty()) {</span>
<span class="nc" id="L87">			logger.error(&quot;No existe el archivo {} que contiene al request de ECHO&quot;,</span>
					PropertyHandler.getPropertyString(ECHO_FILE_REQUEST));
<span class="nc" id="L89">			return ERROR_CONFIGURACION;</span>
		}

		ConnectorRequest readValue;
		try {
<span class="nc" id="L94">			readValue = mapper.readValue(requestJson, ConnectorRequest.class);</span>
<span class="nc" id="L95">			readValue.getBillersPlusRequest().setProductoUtilityCode(productoUtilityCode);</span>
<span class="nc" id="L96">		} catch (IOException e) {</span>
<span class="nc" id="L97">			logger.error(&quot;Existio una excepcion en la operacion de echo al deserializar el request&quot;);</span>
<span class="nc" id="L98">			return ERROR_CONFIGURACION;</span>
<span class="nc" id="L99">		}</span>

<span class="nc" id="L101">		DTORequestCashOutConfirm directaRequest = (DTORequestCashOutConfirm) transformer.getDirectaRequest(readValue);</span>

<span class="nc" id="L103">		DateTime initTime = DateTime.now();</span>
<span class="nc" id="L104">		BillerResponseWrapper&lt;?&gt; billerResponse = client.directa(directaRequest);</span>
<span class="nc" id="L105">		DateTime endTime = DateTime.now();</span>
<span class="nc" id="L106">		long durationMillis = new Interval(initTime, endTime).toDurationMillis();</span>

<span class="nc" id="L108">		ConnectorResponse&lt;PagoResponse&gt; consultaDeuda = transformer.getResponseForDirecta(new PagoResponse(),</span>
				billerResponse);

<span class="nc" id="L111">		logger.debug(&quot;[Conector Codigo {}] la operación ECHO tardó {}ms devolvió un código de error {}&quot;,</span>
				PropertyHelper.getConnectorCode(), durationMillis);
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if (consultaDeuda.getResponse().getCodigoError() == 34) {</span>
<span class="nc" id="L114">			return durationMillis;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		} else if (consultaDeuda.getResponse().getCodigoError() == 1) {</span>
<span class="nc" id="L116">			logger.debug(&quot;[Conector Codigo {}] la operación ECHO retornará un error no critico&quot;,</span>
					PropertyHelper.getConnectorCode(), durationMillis);
<span class="nc" id="L118">			return ERROR_NO_CRITICO;</span>
		} else {
<span class="nc" id="L120">			logger.debug(&quot;[Conector Codigo {}] la operación ECHO retornará un error critico&quot;,</span>
					PropertyHelper.getConnectorCode());
<span class="nc" id="L122">			return ERROR_CRITICO;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>